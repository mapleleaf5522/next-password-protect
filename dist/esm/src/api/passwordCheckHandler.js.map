{"version":3,"file":"passwordCheckHandler.js","sources":["../../../../src/api/passwordCheckHandler.ts"],"sourcesContent":["import cookie from 'cookie';\nimport { Request, Response } from 'express';\nimport jwt from 'jsonwebtoken';\n\nimport { sendJson } from './sendJson';\n\ninterface PasswordProtectHandlerOptions {\n  /* @default next-password-protect */\n  cookieName?: string;\n}\n\nexport const passwordCheckHandler = (\n  password: string,\n  options?: PasswordProtectHandlerOptions,\n) => async (req: Request, res: Response) => {\n  res.setHeader('Content-Type', 'application/json');\n  res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate'); // HTTP 1.1.\n  res.setHeader('Pragma', 'no-cache'); // HTTP 1.0.\n  res.setHeader('Expires', '0'); // Proxies.\n\n  try {\n    if (req.method !== 'GET') {\n      throw new Error('Invalid method.');\n    }\n\n    if (req?.headers?.cookie) {\n      const cookies = cookie.parse(req.headers.cookie);\n      const cookieName = options?.cookieName || 'next-password-protect';\n\n      /* NOTE: It's not usual to use the password as JWT secret, but since you already\n       * have access to the environment when you know the password, in this specific\n       * use case it doesn't add any value for an intruder if the secret is known.\n       */\n      jwt.verify(cookies?.[cookieName], password);\n\n      sendJson(res, 200);\n      return;\n    }\n\n    sendJson(res, 401);\n  } catch (err) {\n    if (err.name === 'JsonWebTokenError') {\n      sendJson(res, 401);\n      return;\n    }\n\n    sendJson(res, 500, { message: err?.message || 'An error has occured.' });\n  }\n};\n"],"names":["passwordCheckHandler","password","options","req","res","setHeader","method","Error","headers","cookie","cookies","parse","cookieName","jwt","verify","sendJson","err","name","message"],"mappings":"0OAWaA,EAAuB,SAClCC,EACAC,UACG,SAAOC,EAAcC,kFACxBA,EAAIC,UAAU,eAAgB,oBAC9BD,EAAIC,UAAU,gBAAiB,uCAC/BD,EAAIC,UAAU,SAAU,YACxBD,EAAIC,UAAU,UAAW,YAGJ,QAAfF,EAAIG,aACA,IAAIC,MAAM,gCAGdJ,MAAAA,SAAAA,EAAKK,8BAASC,cACVC,EAAUD,EAAOE,MAAMR,EAAIK,QAAQC,QACnCG,GAAaV,MAAAA,SAAAA,EAASU,aAAc,wBAM1CC,EAAIC,OAAOJ,MAAAA,SAAAA,EAAUE,GAAaX,GAElCc,EAASX,EAAK,SAIhBW,EAASX,EAAK,KACd,MAAOY,MACU,sBAAbA,EAAIC,YACNF,EAASX,EAAK,SAIhBW,EAASX,EAAK,IAAK,CAAEc,SAASF,MAAAA,SAAAA,EAAKE,UAAW"}